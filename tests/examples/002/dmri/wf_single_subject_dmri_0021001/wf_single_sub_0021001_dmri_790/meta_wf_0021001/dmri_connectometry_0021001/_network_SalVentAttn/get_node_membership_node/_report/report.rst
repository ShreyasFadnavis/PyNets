Node: meta_wf_0021001 (dmri_connectometry_0021001 (get_node_membership_node (utility)
=====================================================================================


 Hierarchy : wf_single_sub_0021001_dmri_790.meta_wf_0021001.dmri_connectometry_0021001.get_node_membership_node
 Exec ID : get_node_membership_node.cI.c1


Original Inputs
---------------


* coords : [[-39.40774665  -9.04783285  44.00269397]
 [ -7.43663158 -59.25827368  37.86349474]
 [ -5.29388682  39.69537381   6.23667906]
 [-13.39120945 -16.23295962  14.89086219]
 [-34.         -34.          -5.75      ]
 [-27.66990809 -59.83579899 -38.62715683]
 [-20.38812245 -47.51814791 -35.86346142]
 [-37.63897527  42.55678958  18.29409151]
 [-12.9633117   33.74328278  41.0403874 ]
 [-11.61810386 -18.42696522   6.79313959]
 [-12.63600396   9.12141444  10.67334322]
 [-24.48445284   1.78268339   1.53719292]
 [-19.39536138  -3.38457389  -0.67475728]
 [ -1.1030303  -10.01212121  -1.35151515]
 [ -4.27663331 -39.44496763 -32.73866981]
 [ -6.3191898  -27.34677842 -34.81255457]
 [-25.47759724 -22.06794682 -12.82964057]
 [-21.47991968  -5.22188755 -18.10341365]
 [-36.20065008   1.58607326  -0.25890736]
 [-46.02027559  13.76712598  12.43307087]
 [-46.38786232  32.45126812   5.49402174]
 [ -9.7127572  -81.95144033   6.20534979]
 [ -2.06963788 -25.01671309   9.76044568]
 [ -9.28142077  11.34699454  -7.08469945]
 [ -9.84567901 -15.81265432  -9.73657407]
 [-28.          -2.          -8.        ]
 [-40.52919559  32.92976725 -10.45406288]
 [ 14.35376532 -15.67192061  15.144892  ]
 [ 25.46987952 -15.01204819 -11.63855422]
 [ -1.68587896 -47.99711816 -50.91066282]
 [ -1.74736842 -50.93684211 -26.46315789]
 [ 12.1919403  -17.78547264   7.17114428]
 [ 14.20635674  10.36005693  11.24691651]
 [ 25.62502444   2.43147605   1.5769306 ]
 [ 20.5507772   -2.83523316  -0.70777202]
 [ 26.30807397 -20.53450609 -12.81235904]
 [ 21.93        -4.24888889 -18.41777778]
 [  9.19578313  11.24698795  -6.40060241]
 [-24.55775125 -62.69099855  50.64849169]
 [ 10.77466562 -15.93674272  -9.79040126]
 [-22.03214562 -31.49922541 -17.83152595]
 [-50.25136791 -10.39928915  -6.63124912]
 [-53.12214603 -38.11717278  34.63077387]
 [-44.98768633 -21.46208684   8.45106935]
 [ -3.46808511   2.76595745 -10.91489362]
 [  6.45205479   3.70547945 -11.23287671]
 [ -4.46764253 -50.63995891 -13.20005136]
 [ -3.64342857 -66.68971429 -23.60742857]
 [ -4.04270938 -57.24758091 -38.75942609]
 [ -6.17316943 -25.68163193  57.79975058]
 [-57.46055697 -27.80877621 -12.65871519]
 [  5.4625651   21.54329427  28.04296875]
 [ 37.53156103  12.98349921  47.44722368]
 [  9.32470444 -79.53383612  23.1946596 ]
 [ 22.6098635   -4.56230735 -31.95640687]
 [ 34.79281102 -43.04760528 -20.99951817]
 [ 46.24613187 -65.41561533  30.40984289]
 [ 49.02416244 -28.17928934 -27.29678511]
 [  7.90322581 -44.98354839  19.30645161]
 [ 32.80915227 -86.42231717   2.04755712]
 [ 22.2122093   36.89347337 -17.91757314]
 [ 13.6988191  -66.42386874  -5.03918905]
 [  5.23006135  37.48432175 -17.26993865]
 [ 58.32844866 -25.23297708 -12.50093654]
 [ 24.10399334 -29.37895175 -18.43427621]
 [  7.53763026 -24.85488228  58.69490544]
 [ 48.40639193  15.13254836  13.54583684]
 [ 42.43845252  34.29503712 -11.10746385]
 [ 48.22581281  32.69162562   4.66876847]
 [ 12.23624954 -79.71576227   7.05204873]
 [ 45.29406347 -21.88872143  43.83195177]
 [  5.79049467 -16.93622696  39.24515034]
 [ 41.46036719  -7.7177768   44.17087537]
 [  9.59039273 -57.63299253  37.98847777]
 [ -5.28925825  20.86876706  31.68097246]
 [ 39.24827087  43.88000643  17.95375583]
 [ 13.54483621  34.52466355  38.67653984]
 [ 25.51007813 -60.26367188  53.30015625]
 [ 51.52368964  -6.54267157  -8.07164795]
 [ 54.18698939 -35.04665191  36.22738032]
 [-35.83066274  12.09024484  47.08011793]
 [  5.86218182  37.532        2.95709091]
 [ 46.06022409 -17.97478992   8.11204482]
 [ 37.50006131   2.23874923   0.19264255]
 [ -7.08703156 -81.85428994  21.14423077]
 [-22.87226126  -5.03183134 -32.04257958]
 [-36.15644349 -46.70172542 -20.03937918]
 [-41.55397548 -70.55625079  32.08886361]
 [-48.32543193 -28.42695232 -28.30117484]
 [ -6.3807937  -46.63617086  19.25295365]
 [-29.8504807  -89.22470943   1.50272636]
 [-22.22757966  36.75416755 -17.43680101]
 [-13.29384318 -67.50893365  -5.87891203]
 [ -5.10974742  41.00942725 -16.83137673]
 [-43.53290192 -23.8616872   43.53906128]
 [ -5.21337127 -18.39260313  39.69630156]]
* function_str : def get_node_membership(network, infile, coords, labels, parc, parcel_list, perc_overlap=0.75, error=4):
    """
    Evaluate the affinity of any arbitrary list of coordinate or parcel nodes for a user-specified RSN based on
    Yeo-7 or Yeo-17 definitions.

    Parameters
    ----------
    network : str
        Resting-state network based on Yeo-7 and Yeo-17 naming (e.g. 'Default') used to filter nodes in the study of
        brain subgraphs.
    infile : str
        File path to Nifti1Image object whose affine will provide sampling reference for evaluation spatial proximity.
    coords : list
        List of (x, y, z) tuples in mm-space corresponding to a coordinate atlas used or
        which represent the center-of-mass of each parcellation node.
    labels : list
        List of string labels corresponding to ROI nodes.
    parc : bool
        Indicates whether to use parcels instead of coordinates as ROI nodes.
    parcel_list : list
        List of 3D boolean numpy arrays or binarized Nifti1Images corresponding to ROI masks.
    perc_overlap : float
        Value 0-1 indicating a threshold of spatial overlap to use as a spatial error cushion in the case of
        evaluating RSN membership from a given list of parcel masks. Default is 0.75.
    error : int
        Rounded euclidean distance, in units of voxel number, to use as a spatial error cushion in the case of
        evaluating RSN membership from a given list of coordinates. Default is 4.

    Returns
    -------
    coords_mm : list
        Filtered list of (x, y, z) tuples in mm-space with a spatial affinity for the specified RSN.
    RSN_parcels : list
        Filtered list of 3D boolean numpy arrays or binarized Nifti1Images corresponding to ROI masks with a spatial
        affinity for the specified RSN.
    net_labels : list
        Filtered list of string labels corresponding to ROI nodes with a spatial affinity for the specified RSN.
    network : str
        Resting-state network based on Yeo-7 and Yeo-17 naming (e.g. 'Default') used to filter nodes in the study of
        brain subgraphs.
    """
    from nilearn.image import resample_img
    from pynets.nodemaker import get_sphere, mmToVox, VoxTomm
    import pkg_resources
    import pandas as pd

    # Determine whether input is from 17-networks or 7-networks
    seven_nets = ['Vis', 'SomMot', 'DorsAttn', 'SalVentAttn', 'Limbic', 'Cont', 'Default']
    seventeen_nets = ['VisCent', 'VisPeri', 'SomMotA', 'SomMotB', 'DorsAttnA', 'DorsAttnB', 'SalVentAttnA',
                      'SalVentAttnB', 'LimbicOFC', 'LimbicTempPole', 'ContA', 'ContB', 'ContC', 'DefaultA', 'DefaultB',
                      'DefaultC', 'TempPar']

    # Load subject func data
    bna_img = nib.load(infile)
    x_vox = np.diagonal(bna_img.affine[:3, 0:3])[0]
    y_vox = np.diagonal(bna_img.affine[:3, 0:3])[1]
    z_vox = np.diagonal(bna_img.affine[:3, 0:3])[2]

    if network in seventeen_nets:
        if x_vox <= 1 and y_vox <= 1 and z_vox <= 1:
            par_file = pkg_resources.resource_filename("pynets", "rsnrefs/BIGREF1mm.nii.gz")
        else:
            par_file = pkg_resources.resource_filename("pynets", "rsnrefs/BIGREF2mm.nii.gz")

        # Grab RSN reference file
        nets_ref_txt = pkg_resources.resource_filename("pynets", "rsnrefs/Schaefer2018_1000_17nets_ref.txt")
    elif network in seven_nets:
        if x_vox <= 1 and y_vox <= 1 and z_vox <= 1:
            par_file = pkg_resources.resource_filename("pynets", "rsnrefs/SMALLREF1mm.nii.gz")
        else:
            par_file = pkg_resources.resource_filename("pynets", "rsnrefs/SMALLREF2mm.nii.gz")

        # Grab RSN reference file
        nets_ref_txt = pkg_resources.resource_filename("pynets", "rsnrefs/Schaefer2018_1000_7nets_ref.txt")
    else:
        nets_ref_txt = None

    if not nets_ref_txt:
        raise ValueError("%s%s%s" % ('Network: ', str(network), ' not found!\nSee valid network names using the --help '
                                                                'flag with pynets_run.py'))

    # Create membership dictionary
    dict_df = pd.read_csv(nets_ref_txt, sep="\t", header=None, names=["Index", "Region", "X", "Y", "Z"])
    dict_df.Region.unique().tolist()
    ref_dict = {v: k for v, k in enumerate(dict_df.Region.unique().tolist())}
    par_img = nib.load(par_file)
    par_data = par_img.get_fdata()
    RSN_ix = list(ref_dict.keys())[list(ref_dict.values()).index(network)]
    RSNmask = par_data[:, :, :, RSN_ix]
    bna_aff = bna_img.affine

    coords_vox = []
    for i in coords:
        coords_vox.append(mmToVox(bna_aff, i))
    coords_vox = list(tuple(map(lambda y: isinstance(y, float) and int(round(y, 0)), x)) for x in coords_vox)
    if parc is False:
        i = -1
        RSN_parcels = None
        RSN_coords_vox = []
        net_labels = []
        for coords in coords_vox:
            sphere_vol = np.zeros(RSNmask.shape, dtype=bool)
            sphere_vol[tuple(coords)] = 1
            i = i + 1
            if (RSNmask.astype('bool') & sphere_vol).any():
                print("%s%s%s%s" % (coords, ' coords falls within ', network, '...'))
                RSN_coords_vox.append(coords)
                net_labels.append(labels[i])
                continue
            else:
                inds = get_sphere(coords, error, (np.abs(x_vox), y_vox, z_vox), RSNmask.shape)
                sphere_vol[tuple(inds.T)] = 1
                if (RSNmask.astype('bool') & sphere_vol).any():
                    print("%s%s%.2f%s%s%s" % (coords, ' coords is within a + or - ', float(error),
                                              ' mm neighborhood of ',
                                              network, '...'))
                    RSN_coords_vox.append(coords)
                    net_labels.append(labels[i])

        coords_mm = []
        for i in RSN_coords_vox:
            coords_mm.append(VoxTomm(bna_aff, i))
        coords_mm = list(set(list(tuple(x) for x in coords_mm)))
    else:
        i = 0
        RSN_parcels = []
        coords_with_parc = []
        net_labels = []
        for parcel in parcel_list:
            parcel_vol = np.zeros(RSNmask.shape, dtype=bool)
            parcel_data_reshaped = resample_img(parcel, target_affine=par_img.affine,
                                                target_shape=RSNmask.shape).get_fdata()
            parcel_vol[parcel_data_reshaped == 1] = 1

            # Count number of unique voxels where overlap of parcel and mask occurs
            overlap_count = len(np.unique(np.where((RSNmask.astype('uint8') == 1) & (parcel_vol.astype('uint8') == 1))))

            # Count number of total unique voxels within the parcel
            total_count = len(np.unique(np.where((parcel_vol.astype('uint8') == 1))))

            # Calculate % overlap
            try:
                overlap = float(overlap_count / total_count)
            except RuntimeWarning:
                print('\nWarning: No overlap with roi mask!\n')
                overlap = float(0)

            if overlap >= perc_overlap:
                print("%.2f%s%s%s%s%s" % (100 * overlap, '% of parcel ', labels[i], ' falls within ', str(network),
                                          ' mask...'))
                RSN_parcels.append(parcel)
                coords_with_parc.append(coords[i])
                net_labels.append(labels[i])
            i = i + 1
        coords_mm = list(set(list(tuple(x) for x in coords_with_parc)))

    bna_img.uncache()
    if len(coords_mm) <= 1:
        raise ValueError("%s%s%s" % ('\nERROR: No coords from the specified atlas found within ', network, ' network.'))

    return coords_mm, RSN_parcels, net_labels, network

* infile : /usr/local/fsl/data/standard/MNI152_T1_2mm_brain.nii.gz
* labels : [nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan, nan]
* network : SalVentAttn
* networks_list : None
* par_max : 96
* parc : True
* parcel_list : [<nibabel.nifti1.Nifti1Image object at 0xa200bce48>, <nibabel.nifti1.Nifti1Image object at 0xd2205a080>, <nibabel.nifti1.Nifti1Image object at 0xd2205a128>, <nibabel.nifti1.Nifti1Image object at 0xd2205a208>, <nibabel.nifti1.Nifti1Image object at 0xd2205a358>, <nibabel.nifti1.Nifti1Image object at 0xd2205a4a8>, <nibabel.nifti1.Nifti1Image object at 0xd2205a5f8>, <nibabel.nifti1.Nifti1Image object at 0xd2205a748>, <nibabel.nifti1.Nifti1Image object at 0xd2205a898>, <nibabel.nifti1.Nifti1Image object at 0xd2205a9e8>, <nibabel.nifti1.Nifti1Image object at 0xd2205ab38>, <nibabel.nifti1.Nifti1Image object at 0xd2205ac88>, <nibabel.nifti1.Nifti1Image object at 0xd2205add8>, <nibabel.nifti1.Nifti1Image object at 0xd2205af28>, <nibabel.nifti1.Nifti1Image object at 0xd220620b8>, <nibabel.nifti1.Nifti1Image object at 0xd22062208>, <nibabel.nifti1.Nifti1Image object at 0xd22062358>, <nibabel.nifti1.Nifti1Image object at 0xd220624a8>, <nibabel.nifti1.Nifti1Image object at 0xd220625f8>, <nibabel.nifti1.Nifti1Image object at 0xd22062748>, <nibabel.nifti1.Nifti1Image object at 0xd22062898>, <nibabel.nifti1.Nifti1Image object at 0xd220629e8>, <nibabel.nifti1.Nifti1Image object at 0xd22062b38>, <nibabel.nifti1.Nifti1Image object at 0xd22062c88>, <nibabel.nifti1.Nifti1Image object at 0xd22062dd8>, <nibabel.nifti1.Nifti1Image object at 0xd22062f28>, <nibabel.nifti1.Nifti1Image object at 0xa1fa690b8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69208>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69358>, <nibabel.nifti1.Nifti1Image object at 0xa1fa694a8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa695f8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69748>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69898>, <nibabel.nifti1.Nifti1Image object at 0xa1fa699e8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69b38>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69c88>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69dd8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa69f28>, <nibabel.nifti1.Nifti1Image object at 0xa1fa710b8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71208>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71358>, <nibabel.nifti1.Nifti1Image object at 0xa1fa714a8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa715f8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71748>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71898>, <nibabel.nifti1.Nifti1Image object at 0xa1fa719e8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71b38>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71c88>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71dd8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa71f28>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f0b8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f208>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f358>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f4a8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f5f8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f748>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f898>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7f9e8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7fb38>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7fc88>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7fdd8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa7ff28>, <nibabel.nifti1.Nifti1Image object at 0xa1fa890b8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89208>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89358>, <nibabel.nifti1.Nifti1Image object at 0xa1fa894a8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa895f8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89748>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89898>, <nibabel.nifti1.Nifti1Image object at 0xa1fa899e8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89b38>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89c88>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89dd8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa89f28>, <nibabel.nifti1.Nifti1Image object at 0xa1fa940b8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94208>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94358>, <nibabel.nifti1.Nifti1Image object at 0xa1fa944a8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa945f8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94748>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94898>, <nibabel.nifti1.Nifti1Image object at 0xa1fa949e8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94b38>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94c88>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94dd8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa94f28>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d0b8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d208>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d358>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d4a8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d5f8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d748>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d898>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9d9e8>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9db38>, <nibabel.nifti1.Nifti1Image object at 0xa1fa9dc88>]

